"use strict";(self.webpackChunkuseful_resources=self.webpackChunkuseful_resources||[]).push([[517],{9613:(e,a,o)=>{o.d(a,{Zo:()=>m,kt:()=>k});var r=o(9496);function n(e,a,o){return a in e?Object.defineProperty(e,a,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[a]=o,e}function t(e,a){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);a&&(r=r.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),o.push.apply(o,r)}return o}function i(e){for(var a=1;a<arguments.length;a++){var o=null!=arguments[a]?arguments[a]:{};a%2?t(Object(o),!0).forEach((function(a){n(e,a,o[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):t(Object(o)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(o,a))}))}return e}function s(e,a){if(null==e)return{};var o,r,n=function(e,a){if(null==e)return{};var o,r,n={},t=Object.keys(e);for(r=0;r<t.length;r++)o=t[r],a.indexOf(o)>=0||(n[o]=e[o]);return n}(e,a);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(r=0;r<t.length;r++)o=t[r],a.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var p=r.createContext({}),l=function(e){var a=r.useContext(p),o=a;return e&&(o="function"==typeof e?e(a):i(i({},a),e)),o},m=function(e){var a=l(e.components);return r.createElement(p.Provider,{value:a},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var a=e.children;return r.createElement(r.Fragment,{},a)}},u=r.forwardRef((function(e,a){var o=e.components,n=e.mdxType,t=e.originalType,p=e.parentName,m=s(e,["components","mdxType","originalType","parentName"]),d=l(o),u=n,k=d["".concat(p,".").concat(u)]||d[u]||c[u]||t;return o?r.createElement(k,i(i({ref:a},m),{},{components:o})):r.createElement(k,i({ref:a},m))}));function k(e,a){var o=arguments,n=a&&a.mdxType;if("string"==typeof e||n){var t=o.length,i=new Array(t);i[0]=u;var s={};for(var p in a)hasOwnProperty.call(a,p)&&(s[p]=a[p]);s.originalType=e,s[d]="string"==typeof e?e:n,i[1]=s;for(var l=2;l<t;l++)i[l]=o[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,o)}u.displayName="MDXCreateElement"},9158:(e,a,o)=>{o.r(a),o.d(a,{assets:()=>p,contentTitle:()=>i,default:()=>c,frontMatter:()=>t,metadata:()=>s,toc:()=>l});var r=o(7605),n=(o(9496),o(9613));const t={sidebar_position:2,slug:"otimization"},i="Otimiza\xe7\xe3o de Build",s={unversionedId:"docker/otimiza\xe7\xe3o",id:"docker/otimiza\xe7\xe3o",title:"Otimiza\xe7\xe3o de Build",description:"Para ambientes de desenvolvimento local muitas vezes configuramos o Dockerfile ou docker-compose.yml da forma mais r\xe1pida, pronta para o desenvolvimento. Mas quando esses projetos precisam rodar em um ambiente de produ\xe7\xe3o, \xe9 imprescind\xedvel realizar otimiza\xe7\xf5es. Sejam otimiza\xe7\xf5es no tamanho final da imagem, de desempenho, tempo de build ou seguran\xe7a.",source:"@site/docs/docker/otimiza\xe7\xe3o.md",sourceDirName:"docker",slug:"/docker/otimization",permalink:"/docs/docker/otimization",draft:!1,editUrl:"https://github.com/hotaydev/hotaydev.github.io/tree/main/docs/docker/otimiza\xe7\xe3o.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,slug:"otimization"},sidebar:"tutorialSidebar",previous:{title:"Introdu\xe7\xe3o ao assunto",permalink:"/docs/docker/intro"},next:{title:"Recomenda\xe7\xf5es de seguran\xe7a",permalink:"/docs/docker/security"}},p={},l=[{value:"1. Cria\xe7\xe3o da imagem em duas etapas",id:"1-cria\xe7\xe3o-da-imagem-em-duas-etapas",level:3},{value:"2. Utilize imagens m\xednimas como base",id:"2-utilize-imagens-m\xednimas-como-base",level:3},{value:"3. Configure seu projeto para fazer cache e utilizar configura\xe7\xf5es de produ\xe7\xe3o",id:"3-configure-seu-projeto-para-fazer-cache-e-utilizar-configura\xe7\xf5es-de-produ\xe7\xe3o",level:3},{value:"Considera\xe7\xf5es",id:"considera\xe7\xf5es",level:2}],m={toc:l},d="wrapper";function c(e){let{components:a,...o}=e;return(0,n.kt)(d,(0,r.Z)({},m,o,{components:a,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"otimiza\xe7\xe3o-de-build"},"Otimiza\xe7\xe3o de Build"),(0,n.kt)("p",null,"Para ambientes de desenvolvimento local muitas vezes configuramos o ",(0,n.kt)("inlineCode",{parentName:"p"},"Dockerfile")," ou ",(0,n.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," da forma mais r\xe1pida, pronta para o desenvolvimento. Mas quando esses projetos precisam rodar em um ambiente de produ\xe7\xe3o, \xe9 imprescind\xedvel realizar otimiza\xe7\xf5es. Sejam otimiza\xe7\xf5es no ",(0,n.kt)("strong",{parentName:"p"},"tamanho final da imagem"),", de ",(0,n.kt)("strong",{parentName:"p"},"desempenho"),", ",(0,n.kt)("strong",{parentName:"p"},"tempo de build")," ou ",(0,n.kt)("strong",{parentName:"p"},"seguran\xe7a"),"."),(0,n.kt)("h3",{id:"1-cria\xe7\xe3o-da-imagem-em-duas-etapas"},"1. Cria\xe7\xe3o da imagem em duas etapas"),(0,n.kt)("p",null,"O processo mais comum para gerar uma imagem atrav\xe9s do ",(0,n.kt)("inlineCode",{parentName:"p"},"Dockerfile")," \xe9 copiar os arquivos para a imagem, instalar as depend\xeancias, gerar uma build de produ\xe7\xe3o e ent\xe3o rodar a aplica\xe7\xe3o. Mas podemos quebrar esse processo em duas partes, uma focada no processo de build e uma focada em rodar a aplica\xe7\xe3o."),(0,n.kt)("p",null,"Abaixo seguem alguns passos para realizar este processo:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Utilize a imagem de base - \xe9 sempre recomendado utilizar a imagem ",(0,n.kt)("a",{parentName:"li",href:"https://hub.docker.com/_/alpine"},"alpine")," ou ",(0,n.kt)("a",{parentName:"li",href:"https://hub.docker.com/_/scratch"},"scratch"),". Importante adicionar o ",(0,n.kt)("inlineCode",{parentName:"li"},"AS builder")," no final, para dar umma esp\xe9cie de nome \xe0 primeira imagem que vamos criar:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"FROM alpine:3.18.4@sha256:48d9183eb12a05c99bcc0bf44a003607b8e941e1d4f41f9ad12bdcc4b5672f86 AS builder\n")),(0,n.kt)("ol",{start:2},(0,n.kt)("li",{parentName:"ol"},"Copie os arquivos necess\xe1rios para realizar a build e instala\xe7\xe3o de depend\xeancias:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"WORKDIR /var/www\n\n# Exemplo para um projeto Node JS\nCOPY package*.json ./\nCOPY tsconfig*.json ./\n\n# Pasta com o c\xf3digo\nCOPY ./src/ ./src/\n\n")),(0,n.kt)("ol",{start:3},(0,n.kt)("li",{parentName:"ol"},"Instale as ferramentas necess\xe1rias (no exemplo vamos instalar o NodeJS):")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"RUN apk add --update nodejs npm\n")),(0,n.kt)("ol",{start:4},(0,n.kt)("li",{parentName:"ol"},"Instale as depend\xeancias de produ\xe7\xe3o e de desenvolvimento e gere a build:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"RUN npm install\n\n# Seu comando de build abaixo\nRUN npm run build\n")),(0,n.kt)("ol",{start:5},(0,n.kt)("li",{parentName:"ol"},"No mesmo arquivo, utilize uma nova imagem. Repare que nesta parte n\xe3o adicionamos o ",(0,n.kt)("inlineCode",{parentName:"li"},"AS <nome>"),":")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"FROM alpine:3.18.4@sha256:48d9183eb12a05c99bcc0bf44a003607b8e941e1d4f41f9ad12bdcc4b5672f86\nWORKDIR /var/www\n")),(0,n.kt)("ol",{start:6},(0,n.kt)("li",{parentName:"ol"},"Instale novamente as ferramentas necess\xe1rias - mas desta vez apenas as ferramentas realmente necess\xe1rias para rodar o projeto. isso significa que, por exemplo, se voc\xea precisa do python para gerar a build, mas n\xe3o precisa de python para rodar o projeto, voc\xea n\xe3o precisa instalar o python nessa etapa:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"RUN apk add --update nodejs npm\n")),(0,n.kt)("ol",{start:7},(0,n.kt)("li",{parentName:"ol"},"Copie os arquivos necess\xe1rios para a instala\xe7\xe3o de depend\xeancias e instale as depend\xeancias de produ\xe7\xe3o (apenas as de produ\xe7\xe3o):")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"COPY package*.json ./\n\n# Caso esteja usando NodeJS, configure a vari\xe1vel NODE_ENV=production para um melhor desempenho\nENV NODE_ENV=production\n\n# Na instala\xe7\xe3o de depend\xeancias de produ\xe7\xe3o vamos utilizar o npm ci ao inv\xe9s do npm install.\n# Fazemos isso pois o npm ci vai instalar apenas as depend\xeancias de produ\xe7\xe3o e com base no arquivo package-lock.json\n# Baseando-se no arquivo package-lock.json, o npm consegue otimizar o processo de instala\xe7\xe3o, reduzindo o espa\xe7o utilizado\nRUN npm ci\n")),(0,n.kt)("ol",{start:8},(0,n.kt)("li",{parentName:"ol"},"Copie a build gerado no passo 4 para a nova imagem:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"COPY --from=builder /var/www/dist/ .\n")),(0,n.kt)("ol",{start:9},(0,n.kt)("li",{parentName:"ol"},"Adicione um usu\xe1rio sem acesso root (",(0,n.kt)("a",{parentName:"li",href:"../security/"},"para mais informa\xe7\xf5es, clique aqui"),"):")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"RUN addgroup -S nonroot && adduser -S nonroot -G nonroot\nUSER nonroot\n")),(0,n.kt)("ol",{start:10},(0,n.kt)("li",{parentName:"ol"},"Exponha a porta do projeto e execute o entrypoint:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'ENTRYPOINT [ "node", "index.js" ]\nEXPOSE 3012\n')),(0,n.kt)("admonition",{type:"info"},(0,n.kt)("p",{parentName:"admonition"},"Lembre-se de verificar o nome dos arquivos, pastas, comandos para rodar e buildar o projeto, etc. Isso varia de projeto para projeto.")),(0,n.kt)("h3",{id:"2-utilize-imagens-m\xednimas-como-base"},"2. Utilize imagens m\xednimas como base"),(0,n.kt)("p",null,"Imagens Docker como as do PHP j\xe1 vem prontas, com PHP e suas depend\xeancias instaladas em uma imagem alpine. O problema disso \xe9 que, as vulnerabilidades de uma imagem alpine (linux) desatualizada v\xe3o estar presentes no ambiente PHP. Para contornar isso, utilizamos imagens Linux m\xednimas (como ",(0,n.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/alpine"},"alpine")," ou ",(0,n.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/scratch"},"scratch"),") como base e instalamos as depend\xeancias nesta imagem."),(0,n.kt)("p",null,"Para utilizar PHP com Laravel, por exemplo, podemos utilizar o seguinte ",(0,n.kt)("inlineCode",{parentName:"p"},"Dockerfile"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'FROM alpine:3.18.4@sha256:eece025e432126ce23f223450a0326fbebde39cdf496a85d8c016293fc851978\n\nWORKDIR /var/www/html\n\nRUN echo "http://dl-cdn.alpinelinux.org/alpine/v3.12/community" >> /etc/apk/repositories\nRUN apk add --update --no-cache php7 php7-fpm libzip-dev zip unzip git php7-pdo_mysql php7-zip curl php7-json php7-phar php7-iconv php7-dom php7-fileinfo php7-tokenizer php7-session php7-mbstring php7-pdo_sqlite php7-sqlite3\n\nRUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer\n\n')),(0,n.kt)("admonition",{type:"info"},(0,n.kt)("p",{parentName:"admonition"},"Sempre que poss\xedvel, tente utilizar a imagem ",(0,n.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/scratch"},"scratch"),", instalando apenas o que \xe9 realmente necess\xe1rio.\nA Scratch \xe9 a imagem base de todas as outras imagens, o kernel mais b\xe1sico para imagens Docker.")),(0,n.kt)("h3",{id:"3-configure-seu-projeto-para-fazer-cache-e-utilizar-configura\xe7\xf5es-de-produ\xe7\xe3o"},"3. Configure seu projeto para fazer cache e utilizar configura\xe7\xf5es de produ\xe7\xe3o"),(0,n.kt)("p",null,"No caso do NodeJS, podemos fazer isso especificando a vari\xe1vel de ambiente ",(0,n.kt)("inlineCode",{parentName:"p"},"NODE_ENV=production"),". No caso do Laravel, podemos usar comandos como ",(0,n.kt)("inlineCode",{parentName:"p"},"php artisan config:cache"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"php artisan event:generate"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"php artisan route:cache")," e ",(0,n.kt)("inlineCode",{parentName:"p"},"php artisan view:cache"),"."),(0,n.kt)("p",null,"Outros frameworks e linguagens v\xe3o ter suas pr\xf3prias formas de informar que o ambiente \xe9 de produ\xe7\xe3o e de gerar cache do que for necess\xe1rio."),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"considera\xe7\xf5es"},"Considera\xe7\xf5es"),(0,n.kt)("p",null,"Sempre que poss\xedvel utilize a pr\xe1tica de ",(0,n.kt)("a",{parentName:"p",href:"#1-cria%C3%A7%C3%A3o-da-imagem-em-duas-etapas"},"cria\xe7\xe3o da imagem em duas etapas"),", utilizando a primeira step para realizar uma build e a segunda step para rodar o projeto, com apenas o que \xe9 extremamente necess\xe1rio para rodar."),(0,n.kt)("p",null,"Da mesma forma, sempre que poss\xedvel deve-se utilizar uma imagem m\xednima como o alpine e instalar as depend\xeancias nela. Por menor que pare\xe7a, essa mudan\xe7a costuma salvar cerca de 40% do tamanho da imagem."),(0,n.kt)("p",null,"A gera\xe7\xe3o de caches e configura\xe7\xe3o de ambiente de produ\xe7\xe3o ajudam na performance da aplica\xe7\xe3o como um todo."))}c.isMDXComponent=!0}}]);